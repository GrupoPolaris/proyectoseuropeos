<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Proyectos Europeos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        input, select, button { margin: 5px; padding: 8px; width: 200px; }
        .proyecto { border: 1px solid #ddd; padding: 10px; margin-top: 10px; border-radius: 5px; background: #f9f9f9; }
        .total-financiacion { font-size: 18px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Buscador de Proyectos Europeos</h1>
    
    <input type="text" id="titulo" placeholder="Buscar por título">
    <input type="text" id="universidad" placeholder="Buscar por universidad">
    <input type="text" id="comunidad" placeholder="Buscar por Comunidad Autónoma">
    <input type="text" id="programa" placeholder="Buscar por programa"> <!-- Nuevo filtro -->
    <input type="number" id="financiacion" placeholder="Financiación mínima">
    <button onclick="filtrarProyectos()">Buscar</button>
    
    <canvas id="grafico"></canvas>
    <div id="resultados"></div>
    <p id="totalFinanciacion" class="total-financiacion"></p>

    <script>
        let proyectos = [];
        let chart;

        // Cargar proyectos desde el JSON
        fetch("europeos.json")
            .then(response => response.json())
            .then(data => {
                proyectos = data;
                actualizarGrafico(proyectos);  // Actualizar la gráfica al cargar
                mostrarResultados(proyectos);  // Mostrar todos los proyectos por defecto
            })
            .catch(error => console.error("Error cargando JSON:", error));

        // Función para filtrar proyectos
        function filtrarProyectos() {
            let titulo = document.getElementById("titulo").value.toLowerCase();
            let universidad = document.getElementById("universidad").value.toLowerCase();
            let comunidad = document.getElementById("comunidad").value.toLowerCase();
            let programa = document.getElementById("programa").value.toLowerCase(); // Nuevo filtro
            let financiacion = document.getElementById("financiacion").value;

            let proyectosFiltrados = proyectos.filter(proyecto => 
                (titulo === "" || proyecto.nombre.toLowerCase().includes(titulo)) &&
                (universidad === "" || proyecto.universidad.toLowerCase().includes(universidad)) &&
                (comunidad === "" || proyecto.comunidad.toLowerCase().includes(comunidad)) &&
                (programa === "" || proyecto.programa.toLowerCase().includes(programa)) &&  // Nuevo filtro
                (financiacion === "" || parseFloat(proyecto.financiacion.replace("€", "").replace(/\./g, "")) >= parseFloat(financiacion))
            );

            mostrarResultados(proyectosFiltrados);
            actualizarGrafico(proyectosFiltrados);
        }

        // Mostrar resultados filtrados
        function mostrarResultados(resultados) {
            let contenedor = document.getElementById("resultados");
            contenedor.innerHTML = "";

            if (resultados.length === 0) {
                contenedor.innerHTML = "<p>No se encontraron resultados</p>";
                document.getElementById("totalFinanciacion").innerText = "";
                return;
            }

            let totalFinanciacion = 0;
            resultados.forEach(proyecto => {
                let div = document.createElement("div");
                div.classList.add("proyecto");
                div.innerHTML = `<b>${proyecto.nombre}</b> (${proyecto.universidad})<br>
                                 Comunidad: ${proyecto.comunidad}<br>
                                 Programa: ${proyecto.programa}<br>
                                 Financiación: ${proyecto.financiacion}<br>
                                 <a href="${proyecto.link}" target="_blank">Ver más</a>`;
                contenedor.appendChild(div);
                totalFinanciacion += parseFloat(proyecto.financiacion.replace("€", "").replace(/\./g, ""));
            });

            document.getElementById("totalFinanciacion").innerText = `Total financiación: ${totalFinanciacion.toLocaleString()} €`;
        }

        // Función para actualizar la gráfica
        function actualizarGrafico(proyectos) {
            let universidades = {};
            proyectos.forEach(proyecto => {
                let uni = proyecto.universidad;
                let financiacion = parseFloat(proyecto.financiacion.replace("€", "").replace(/\./g, ""));
                universidades[uni] = (universidades[uni] || 0) + financiacion;
            });

            let labels = Object.keys(universidades);
            let data = Object.values(universidades);

            if (chart) chart.destroy();

            let ctx = document.getElementById("grafico").getContext("2d");
            chart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{ label: "Financiación (€)", data: data, backgroundColor: "blue" }]
                },
                options: { responsive: true }
            });
        }
    </script>
</body>
</html>
